name: Deploy Purple Agent

# Purple agent ‚Äî AgentX competition entry.
# Builds Docker image, pushes to private ECR + public ECR, deploys to ECS.
# Green judge lives in github.com/abhishec/agent-bench ‚Äî deployed separately.

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'main.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/deploy.yml'

  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip Docker build (just redeploy ECS from existing ECR image)'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 848269696611.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPO: agentbench-purple
  PUBLIC_ECR_REGISTRY: public.ecr.aws/d9m7h3k5
  PUBLIC_ECR_REPO: agentbench-purple
  ECS_CLUSTER: nexusbrain-training
  ECS_SERVICE: agentbench-purple
  ECS_TASK_DEF: agentbench-purple:3
  PURPLE_URL: https://purple.agentbench.usebrainos.com
  GREEN_URL: https://benchmark.usebrainos.com

jobs:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 1: Build + push Docker image
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  build:
    name: Build + Push Image
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.skip_build != 'true' }}
    outputs:
      image_digest: ${{ steps.push.outputs.digest }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to private ECR
        run: |
          aws ecr get-login-password --region ${{ env.AWS_REGION }} \
            | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

      - name: Login to public ECR
        run: |
          aws ecr-public get-login-password --region us-east-1 \
            | docker login --username AWS --password-stdin public.ecr.aws \
            || echo "‚ö†Ô∏è Public ECR login failed ‚Äî will skip public push"

      - name: Build Docker image
        run: |
          docker build --no-cache --platform linux/amd64 \
            -t ${{ env.ECR_REPO }}:latest .
          echo "‚úÖ Image built"

      - name: Tag and push to private ECR
        id: push
        run: |
          docker tag ${{ env.ECR_REPO }}:latest \
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:latest
          docker push ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:latest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' \
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPO }}:latest 2>/dev/null || echo "")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "‚úÖ Pushed to private ECR"

      - name: Push to public ECR (competition submission)
        run: |
          docker tag ${{ env.ECR_REPO }}:latest \
            ${{ env.PUBLIC_ECR_REGISTRY }}/${{ env.PUBLIC_ECR_REPO }}:latest
          docker push ${{ env.PUBLIC_ECR_REGISTRY }}/${{ env.PUBLIC_ECR_REPO }}:latest \
            && echo "‚úÖ Pushed to public ECR: public.ecr.aws/d9m7h3k5/agentbench-purple:latest" \
            || echo "‚ö†Ô∏è Public ECR push failed (private ECR push succeeded)"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 2: Deploy to ECS
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy:
    name: Deploy ‚Üí ECS
    runs-on: ubuntu-latest
    needs: build
    if: always() && (needs.build.result == 'success' || needs.build.result == 'skipped')

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force deploy ECS service
        run: |
          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ env.ECS_SERVICE }} \
            --task-definition ${{ env.ECS_TASK_DEF }} \
            --force-new-deployment \
            --query 'service.serviceName' --output text
          echo "üöÄ Purple deployment triggered (task-def: ${{ env.ECS_TASK_DEF }})"

      - name: Wait for service to stabilize
        run: |
          echo "Waiting for ECS service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ env.ECS_SERVICE }}
          echo "‚úÖ Purple service stable"

      - name: Health check
        run: |
          sleep 20
          for i in 1 2 3 4 5; do
            R=$(curl -sf ${{ env.PURPLE_URL }}/health 2>/dev/null || echo "")
            if echo "$R" | grep -q '"status":"ok"'; then
              echo "‚úÖ Purple healthy: $R"
              exit 0
            fi
            echo "[$i] not ready, waiting 15s..."
            sleep 15
          done
          echo "‚ùå Health check failed"
          exit 1

      - name: Verify agent card
        run: |
          CARD=$(curl -sf ${{ env.PURPLE_URL }}/.well-known/agent-card.json)
          VERSION=$(echo "$CARD" | python3 -c "import json,sys; print(json.load(sys.stdin)['version'])")
          URL=$(echo "$CARD" | python3 -c "import json,sys; print(json.load(sys.stdin)['url'])")
          echo "version=$VERSION  url=$URL"
          [ "$URL" = "${{ env.PURPLE_URL }}" ] \
            && echo "‚úÖ Agent card correct" \
            || echo "‚ö†Ô∏è URL mismatch: $URL (expected ${{ env.PURPLE_URL }})"

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  # JOB 3: Smoke test via green judge
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  smoke-test:
    name: Smoke Test (via green judge)
    runs-on: ubuntu-latest
    needs: deploy
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Run benchmark ‚Äî task_06 + task_24
        run: |
          echo "üß™ Smoke test via green judge..."
          RESULT=$(curl -sf -X POST ${{ env.GREEN_URL }}/benchmark/batch \
            -H "Content-Type: application/json" \
            -d '{
              "task_ids": ["task_06", "task_24", "task_09"],
              "purple_url": "${{ env.PURPLE_URL }}",
              "difficulty": "none"
            }')
          echo "$RESULT" | python3 -c "
          import json, sys
          r = json.load(sys.stdin, strict=False)
          print(f'Pass rate: {r[\"passed\"]}/{r[\"total\"]} ({r[\"pass_rate\"]*100:.0f}%)')
          for t in r['results']:
              s = t['scores'].get('overall', 0)
              status = '‚úÖ PASS' if s >= 70 else '‚ùå FAIL'
              print(f'  {t[\"task_id\"]}: {s}/100 ‚Äî {status}  ({t[\"tool_calls_count\"]} tool calls)')
          "
          RATE=$(echo "$RESULT" | python3 -c "import json,sys; print(json.load(sys.stdin,strict=False)['pass_rate'])")
          [ "$RATE" = "1.0" ] && echo "‚úÖ All smoke tests PASSED" || echo "‚ö†Ô∏è Some tests failed ‚Äî check scores above"
        timeout-minutes: 6
